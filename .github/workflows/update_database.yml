name: Update OSS Sustain Guard Database

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC to spread load
  workflow_dispatch:

concurrency:
  group: update-database
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  update_database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: uv sync

      - name: Select ecosystem batch
        run: |
          day=$(date -u +%u)
          case "$day" in
            1) batch="python javascript";;
            2) batch="ruby rust";;
            3) batch="php java";;
            4) batch="csharp go";;
            5) batch="python javascript";;
            6) batch="ruby rust";;
            0) batch="php java";;
          esac
          echo "ECOSYSTEM_BATCH=$batch" >> "$GITHUB_ENV"
          echo "Selected batch: $batch"

      - name: Run database builder for selected ecosystems
        timeout-minutes: 300
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LIBRARIESIO_API_KEY: ${{ secrets.LIBRARIESIO_API_KEY }}
        run: |
          if [ -z "$ECOSYSTEM_BATCH" ]; then
            echo "No ecosystems selected; exiting."
            exit 0
          fi

          # Run ecosystems sequentially to respect Libraries.io rate limit (60 req/min)
          # Use --limit 5000, --max-concurrent 5 for better parallelism
          # GitHub Actions will force-kill this step after 5 hours (300 minutes)
          for ecosystem in $ECOSYSTEM_BATCH; do
            echo "Processing $ecosystem..."
            uv run python builder/build_db.py --ecosystems $ecosystem --limit 5000 --max-concurrent 5
            # Check if this ecosystem changed
            if ! git diff --quiet HEAD -- data/latest/$ecosystem.json.gz data/archive/*/; then
              echo "Changes detected in $ecosystem, committing..."
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git add data/latest/$ecosystem.json.gz data/archive/
              git commit -m "chore: update $ecosystem database - $(date -u +'%Y-%m-%d')" || true
              git push
            else
              echo "No changes in $ecosystem"
            fi

            echo "Waiting before next ecosystem..."
            sleep 10
          done

      - name: Commit remaining database changes
        if: always()
        run: |
          # Ensure any remaining changes are committed
          # This handles the case where the step was terminated mid-process
          if ! git diff --quiet HEAD -- data/latest/ data/archive/ data/database.json; then
            echo "Final commit: capturing any remaining database changes..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add data/latest/ data/archive/ data/database.json || true
            git commit -m "chore: final database update - $(date -u +'%Y-%m-%d')" || true
            git push || true
          else
            echo "No remaining changes to commit"
          fi
